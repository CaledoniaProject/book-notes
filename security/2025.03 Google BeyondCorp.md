# 参考资料

从 [research.google](https://research.google/pubs/) 搜索BeyondCorp字样，可以找到所有论文

- [BeyondCorp: A New Approach to Enterprise Security - by Rory Ward and Betsy Beyer](https://www.usenix.org/system/files/login/articles/login_dec14_02_ward.pdf)
- [BeyondCorp: Design to Deployment at Google](https://storage.googleapis.com/pub-tools-public-publication-data/pdf/44860.pdf)
- [BeyondCorp: The Access Proxy](https://storage.googleapis.com/pub-tools-public-publication-data/pdf/45728.pdf)
- [Migrating to BeyondCorp: Maintaining Productivity While Improving Security](https://www.usenix.org/system/files/login/articles/login_summer17_10_peck.pdf)
- [BeyondCorp: The User Experience](https://storage.googleapis.com/pub-tools-public-publication-data/pdf/c8da594124dab1f91e6750995e2b7805403b19f1.pdf)
- [BeyondCorp 6: Building a Healthy Fleet](https://storage.googleapis.com/gweb-research2023-media/pubtools/4621.pdf)
- [BeyondCorp and the long tail of Zero Trust](https://www.usenix.org/publications/loginonline/beyondcorp-and-long-tail-zero-trust)



其他材料

- https://cloud.google.com/docs/security/beyondprod
- https://price2meet.com/gcp/docs/security_beyondprod.pdf
- https://cloud.tencent.com/developer/article/1640417
- https://www.secrss.com/articles/40612

# 第一篇 背景和架构介绍

1. 企业普遍采用边界安全模型，就像中世纪城堡一样，过了桥就可以访问城堡内的所有资源。然而近几年各家公司开始接受云技术，另外随着移动办公、多样化的接入设备，物理边界已经不足以保护企业安全。所以Google决定去除“特权内网”，将企业应用放到公网。简单而言，Google只关注账号和设备，不关注从什么网络接入；企业应用要有认证、授权和加密访问。对于内网和外网访问来说，除了访问延迟不应该有其他区别。
2. 核心组件
   - 安全验证设备身份，合并多个数据源，只允许被管理的设备访问企业资源；使用颁发的证书来确认设备身份，证书存储在TPM，用于跟企业服务通信
   - 安全验证用户身份，IAM跟HR系统打通，在员工入职、转岗、离职、职责变更的时候更新数据库；SSO在公网可访问
   - 移除对网络的信任，
     - Google在办公网部署“非特权网络”，即只有基础服务(DNS、DHCP、NTP、Puppet)等系统的访问策略，让用户在内外网访问体验一致
     - Google通过802.1X、radius服务自动划分VLAN，受管理的设备在“非特权网络”，不受管理的在“访客网络"
   - 公网办公体验，公网代理提供全球接入、负载均衡、访问控制、健康检查、DoS防护等常用能力；所有办公业务系统公网都可以解析，CNAME到访问代理
   - 基于资产的访问控制，根据设备类型、设备基线符合程度、员工身份、读写操作等方面决定权限，既有静态规则也有启发式规则
   - 认证流程示例，设备通过证书通过802.1X认证，员工通过2FA登陆SSO，实现设备+身份的双重验证
3. 迁移到零信任网络
   - 业务迁移流程，从特权网络或者VPN可用 -> 特权网络或者通过访问代理可用(通过DNS解析划分让非特权网络走访问代理) -> 从特权网络、非特权网络、公网都可以访问
   - 分析工作流，
     - 挑选工程师、销售、财务、法务等不同角色用户，理解他们的工作流程以及访问代理支持的比例
     - 确认可以使用访问代理的岗位、工作流以及工作位置，通过分析flow日志，当30天内99.9%的工作流可以通过访问代理进行，强制使用访问代理30天时间，如果没有问题就可以迁走了
   - VPN策略，VPN需要审批才能使用；长期不使用VPN的用户自动删除权限；如果访问代理能满足用户需求，推荐用户放弃VPN访问权限
   - 豁免策略，设计豁免流程、记录哪些工作场景无法通过访问代理解决，解决后再通知用户迁移
4. 长尾工作，某些私有协议的应用范围代理暂不支持，支持他们挑战也比较大

# 第二篇 组件和部署方案

BeyondCorp组件

1. 设备和主机信息快照，
2. 分层信任策略，信任度越高的设备token有效期越短，不满足基线的设备只让访问测试网络
3. 资产库服务，从AD、Puppet、Simian等多个服务获取
4. 上报数据类型
   - 观测数据: 如扫描时间、AD策略同步时间、OS版本、安装的软件
   - 规定的数据(比如设备归属人、可以使用这个设备的用户和组、DNS和DHCP信息、VLAN访问权限)，主要是打印机等设备无法自定义
5. 数据处理，把不同数据源的数据转换为通用格式，同一个设备的数据根据各种维度进行合并
6. 信任评估
   - 搜集到所有信息后触发一次评估，比如要最高级别信任需要满足硬盘加密、安装各类管理agent、安装最新补丁、各个数据源都认为安全
   - 设置缓存机制，也可以用来做策略影响面评估；因为缓存带来的策略延迟在1秒左右，问题不大；更主要的问题是缓存的信息缺失，比如登陆来自恶意IP、2FA验证等等
   - 长期不用的设备，可以阻断处理
7. 例外，包含设备黑白名单，以及IOT设备的特殊处理

部署

1. 初始部署
   - 做一个过度方案，复制当前的边界访问策略，应用到不被信任的设备上
   - 从15个数据源生成资产库，每秒30-100次变更。不断搜集数据，替换基于IP的策略为分层信任策略
   - 证书策略，
     - 如果证书变了，无论设备信息是否发生变化都认为是新设备
     - 如果证书在多个设备上出现，当证书以外的信息对不上的时候，降低信任级别
     - 使用证书加密一个GUID，网关通过这个GUID进行加密和设备认证
2. 移动设备，成本很低，因为几乎全是HTTP协议；API也在访问代理后面，所以也要认证
3. 其他传统协议和第三方平台，支持TCP/UDP代理，基于SSH或者客户端SSL隧道，只允许符合安全策略的通信
4. 避免影响用户
   - 场景分析
     - 分析用户工作流有哪些在零信任网络下可以正常工作
     - 哪些工作流给用户过高的权限，或者允许用户绕过限制
   - 一边根据流量模拟策略的影响，一边将策略翻译成每个平台的本地防火墙策略去验证影响或者打印日志。在这个过程中发现了很多废弃的服务还在运行。
   - 跟服务负责人一起迁移到零信任网络。不能立即迁移的服务，通过程序定死一个加白策略过期时间，将责任和压力给到业务。等用户使用的服务迁移的差不多了，这个用户就可以迁移到非特权网络。
5. 随着时间迁移，用户被阻断的原因越来越不明显。通过给用户提示、培训IT、以及开发一个决策结论和信任评估结论分析的服务来解决。

挑战点

1. 数据质量和关联，资产库数据不准很容易造成用户访问权限异常
2. 分散的数据集，这个没看懂
3. 队列处理延迟
4. 跟用户/业务的沟通交流
5. 灾难恢复，恢复流程只有很少的依赖，允许维护人员上去审计日志，然后恢复到最后的可用配置；也有保底接口，可以下推策略让维护人员能够上机维护策略

# 第三篇 访问代理设计

反向代理

1. Google访问代理(AP)实现了Web和SSH网关，在GAE上做了个统一日志分析点。
2. AP基于GFE去扩展的，GFE提供反向代理和TLS加密，AP提供认证和鉴权。

认证

1. AP跟IdP整合进行认证，AP支持OAuth、OpenID Connect以及其他认证协议。
2. 某些通信不支持认证，比如下载最新安全补丁，此时AP需要禁用认证
3. AP请求源站时候去掉认证信息，一方面可以防止请求重放；另一方面对后端透明，后端可以自行实现认证，不会有多余的cookie或者凭据

鉴权

1. 有两种设计方法，基于RPC服务实现统一的ACL引擎，或者实现一个可扩展的ACL表达语言
2. AP上很难做复杂的认证逻辑，这块交给后端做更合适

双向认证

1. 实现了一个Low Overhead Authentication System，通过HTTP Header向后端传递metadata
2. AP可以不断的增加新特性，业务侧可以选择是否使用这些字段，比如获取设备信任程度等等

ACL设计

1. 需要一个通过静态编译提升性能的方案
2. 职责划分
   1. 安全策略团队，负责静态规则
   2. 资产团队，负责决策某个设备或者用户是否能访问
   3. 策略引擎团队，负责执行安全策略
3. 规则设计，找到第一个匹配的策略就结束
   1. 全局规则，比如低信任度设备不允许提交代码
   2. 应用规则，针对服务或者主机名配置的规则，主要是按账号来，比如用户组A可以访问Web应用B
   3. 大部分服务都支持根据URL划分权限，但是某些服务只使用POST，这种Google也没有修改AP去适配
4. 全局规则可用于安全应急，比如强制让低版本跳转到升级提醒页面，30分钟就生效了，漏洞修复的很快

中央日志系统

1. 记录部分请求头、响应码、AP增加的metadata，可以用来调试和灰度规则
2. metadata包含设备标识、用户标识

安全代理特性

1. Google迁移网络架构时候，业务认为AP是最快的保持服务可用的方案
2. AP团队构建代理，业务自助部署、自己测试，减轻AP团队配置规则的压力

多平台认证挑战

1. BeyondCorp的目标是把网络认证转换为设备认证，每一个设备需要有固定不变且不可复制的ID，需要一个数据库记录设备最新状态，且数据库需要包含软件、用户、地理位置等信息
2. 桌面和笔记本，x509证书存储在TPM，但是考虑到证书错误会让用户很头疼，比如证书错了客户端连不上、浏览器会给一个不好的提示。所以Google的AP接受所有的证书，然后通过网页友好的提示证书错误。
3. 移动设备，无法屏蔽错误的证书，iOS使用identifierForVendor，android使用Enterprise Mobility Management管理

特殊情况处理

1. 非HTTP协议，比如SSH通过ProxyCommand + WebSocket实现，自动继承用户浏览器凭据
2. gRPC和TLS协议，通过HTTPS CONNECT协议完成。如果要给LOAS、SSH增加设备认证难度会很大，所以拆分用户和设备认证动作，在HTTPS通信上做设备认证，用户认证在SSH里面做
3. Chrome RDP协议，做了一个AP插件，类似kerberos协议，每个会话认证一次
4. 第三方软件，使用TUN建立隧道，第三方软件无感

总结

1. ACL迁移方案，因为会经常增加规则，所以规则语言尽可能简单
2. 尽早启动ACL落地，让用户尽早熟悉规则、早点暴露问题；让业务尽早开始适配AP，Google还实现了一个cURL的替代品来实现用户和设备认证
3. 让员工自助服务，发动业务去做配置
4. 创建一个让AP给后端传递数据的机制，实现细粒度认证，尽早规划

应急预案

1. 产品应急预案，参考Site Reliability Engineering这本书设计；也有恢复服务的机制，不会因为AP挂了就上不了机器；所有数据本地有快照
2. 安全应急预案，
   1. 用户撤回，增加到一个特殊组，这个特殊组全局禁止访问任何服务；会话凭据、证书有时候会泄露，需要有撤回流程
   2. 设备通过流水线验证了才会被信任，所以即使CA丢失了也不怕。所以Google没有设计CRL机制，如果怀疑私钥泄露了就降低设备信任级别。
   3. 很多规则由业务编写，所以不可避免会出问题，需要有一个快速回滚、快速发布规则的能力

工程师需要支持

1. 如果减轻业务负责人的压力是主要目标，不要给他们太多意外问题
2. 好好写文档和操作指南
3. 在沙箱环境做验证，不要直接上线

展望未来

1. 电脑和手机认证方案不一样，是个痛点
2. 证书轮换也是痛苦，而且浏览器还要重启才能生效
3. Google打算去做一个桌管软件，统一颁发OAuth Token，实现Device-User-Session-ID (DUSI)，然后就不用证书了

# 第四篇 迁移到零信任网络

主要挑战

1. 迁移到零信任网络是全公司的事情，需要所有级别的管理层的支持，需要跟各个团队深度沟通，包括业务负责人、管理层、技术支持、普通企业用户
2. 迁移需要一个过程，要分层、逐步推进，包括信息搜集、灰度测试、技术和流程改进、例外和恢复措施
3. 多层次的挑战，网络、安全网关、客户端平台、后端服务。需要并行去做改造，才能让项目更可控

准备工作: 承诺和沟通

1. 需要各个级别的管理层和既得利益者的积极支持，要讲清楚零信任的价值和成本: 在保持生产力的同时，减少成功的网络攻击
2. 列出需要支持你工作的各个领域的领导，包括安全、账号、网络、各类客户端软件和服务端、第三方合作伙伴、IT外包，确保他们有精力一起折腾。BeyondCorp是一个虚拟全球团队，由一个负责安全策略的总监+一个技术经理带队

分阶段落地

1. 考虑过在原先的vlan上逐步封禁服务器，考虑到实施难度大、风险很高，不如搞一个新的vlan，然后把设备移动过去
2. 迁移到新vlan的有一个风险，不走访问代理的请求会失败，所以需要并行的做3件事情
   1. 详细分析流量日志
   2. 识别、迁移不兼容的应用
   3. 在确认业务兼容性之后，才能迁移到新的vlan
3. 使用802.1X管理+VLAN划分，把网络层工作与其他细节拆分
4. 考虑到各个环节工作量都不小，为了控制风险，采用如下手段
   1. 解耦网络层工作，新的VLAN、802.1X认证、Radius策略服务器
   2. 解耦客户端平台升级工作，证书生成和安装，用户认证工具
   3. 随着服务和工作流不断地兼容访问代理，逐步迁移设备
   4. 持续优化流程

802.1X网络

1. 给所有设备安装证书，切换到802.1X认证: 建立CA、给受控设备安装证书、在交换机上开启认证、与radius服务集成，可并行去做
2. 搭建证书API服务，监控证书在客户端的部署情况
3. 通过自动化脚本识别没有开启802.1X的交换机，确保每个交换机都有新的vlan配置
4. 为了避免新的radius服务器带来问题，初始策略复用了以前的黑白名单策略，并开启观察模式。当新老策略差别很小的时候，就可以开启阻断模式了
5. 之后通过动态vlan划分，可以实现用户设备实时迁移

面向成功的部署

1. 802.1X网络的实施、设备资产库数据源需要很多年才能就绪
2. NFS/CIFS的显然不兼容，这些协议加密和认证强度都不够，所以一定要迁移。迁移方式是用Google Drive这样的网盘代替。但是有些场景，比如CAD，就没法用网盘代替
3. 其他不太明显的场景，要在迁移网络之前发现
4. 通过capirca开源软件生成本地iptables或者其他包过滤器规则，记录所有会在非特权网落下被拦截的请求。在保护隐私的情况下，定位出可以迁移网络的设备，同时找到不兼容的设备、用户和服务，推动他们改造；本地防火墙规则也可以做成阻断模式，有更低的试错成本，也是一个员工自助测试的方案

访问代理简单的用例处理

1. Google对工作站到服务器的通信要求为，认证(设备+用户)、鉴权(设备+用户)、加密、记录日志(HTTP、HTTPS以及使用HTTP包装的SSH)
2. 绝大多数流量都来自浏览器，业务通过文档可以很快完成访问代理配置
3. 通过CNAME解析实现接入，在内网或者外网都是一样的，无需VPN，VPN的技术支持也少了很多
4. 1年迁移了50%的用户到非特权网络

特殊情况处理

1. 非web业务的长尾迁移工作，比如网络磁盘挂载、Java RMI业务、非HTTP的License服务
2. HTTP业务也可能有问题，比如不会提示证书错误、或者负载均衡跟访问代理冲突
3. 实现4层代理解决这些问题，通过路由表把流量转发到TUN设备，通过UDP跟4层代理通信，同时根据ACL决定是否能访问
   - 浏览器HTTP(S)请求: 访问代理
   - 命令行HTTP请求: 访问代理将请求重定向到本地认证代理
   - 单个TCP端口请求: SSH隧道和代理
   - 多个端口或者端口不可预测: 加密隧道代理
   - 对延迟要求极高或者实时应用: 加密隧道代理
4. 除非业务有明确的兼容访问代理的计划，一般下会在非特权网络下开启例外端口策略

逐步迁移和方案调优

1. 前期是把兼容的用户逐步移动到非特权网络，后期是把用户直接放到非特权网络然后给少量场景加白，即 "MNP by default"

给技术支持授权

1. 挑选一组技术人员，给他们一些高权限，作为办公区现场的联系人。他们可以帮着解决问题、升级case到安全策略专家、修改文档
2. 尽量让员工自助，在通知员工迁移的时候就把文档、FAQ、问题升级方式发给员工，还做了个内部讨论组；在web页面上根据错误做了提示，告知解决方案

内部宣传

1. 为了让内部都知道这个项目，做了很多贴纸、宣传语、公告文章宣传，文章里会有一些FAQ。通过这种方式通知、教育用户，并获得信任和支持。
2. 在项目初期，很需要这种技术写手来让员工知道项目的目的和影响

分阶段推进

1. 先从项目组所在的办公区开始搞，逐步扩大到其他区域
2. 随着业务系统接入，在项目组有信心、用户的强支持的情况下，最后再迁移重要的办公业务系统

最后结果

1. 远程访问变得简单，网络管理也简单了

# 第五篇 用户体验

新员工入职体验

1. 入职的时候培训，告知员工不需要VPN权限，可以通过chrome扩展判断BeyondCorp权限是否正常

新设备初始化

1. 员工首次输入密码时自动完成配置，包括推送chrome扩展、资产库更新等等

VPN回收

1. 新入职员工没有VPN权限，在VPN申请页面提示用户BeyondCorp可以解决办公需求，用户应该先尝试用BeyondCorp办公
2. 如果用户依然选择申请VPN权限，如果45天内用户访问过的业务都可以通过访问代理进行，就给用户发个邮件，告知办公场景均可以通过访问代理完成，你的VPN权限将在30天内过期(除非某些办公场景无法支持)。在过期前7天会再次通知，到期后自动回收VPN权限

设备借用

1. Google大部分人都用笔记本，为了解决设备丢失、放错位置等情况，所以设计快速配置笔记本的流程
2. 员工可以借用Chromebook设备，使用最多5天，拿起一个设备就可以办公
3. 设备归还后自动销毁设备证书和设备信任关系，留给下一个借用人

BeyondCorp Chrome扩展

1. chrome扩展自动下载和管理PAC配置，让特定请求转发到访问代理
2. 非内部网站无法通过访问代理进行、或者当chrome扩展无法管理代理配置时，需要提示用户，界面上的按钮会变成红色

用户能自己解决的问题

1. Capitve Portals下无法下载PAC配置: 扩展会访问http://clients3.google.com/generate_204、检查状态码是否为204，则认为是在Captive Portal下，改用内置的PAC配置文件，然后通知用户需要做什么。Chrome扩展会告知用户机场、咖啡厅很容易遇到这个问题，只需要把BeyondCorp暂时关掉就可以了，认证好了再切换回来
2. 本地网络设备: Google员工喜欢用公司电脑连接个人打印机，或者其他在内网的设备，这些同样无法通过访问代理完成。这种场景下用户互联网访问正常，所以不能像检测Captive Portal一样去检查，也不应该提示产生报警。访问代理创建了一个502错误页面，当用户尝试访问RFC1918/RFC6598定义的地址时，提示用户关掉BeyondCorp。
3. 自定义代理配置: 员工有时候需要设置自定义代理来模拟不同国家下的广告效果，为了避免代理冲突，BeyondCorp插件里实现了切换IP出口的功能。另外员工也可以选择关掉BeyondCorp，让其他扩展来管理代理配置

解释复杂的错误场景

1. 说明: 访问代理每天阻断的请求数量有1200万，全都通过人工检查ACL配置不现实。在错误页面上提示用户能做什么，具体展示的错误信息跟用户信任级别有关。由于访问代理可以在公网访问，所以要控制攻击者可以从403页面上获取的信息。
2. 架构设计: 前后端分离，关闭缓存，允许命令行等方式调用API
3. 解释引擎: 再执行一次决策树，定位原因，把ACL翻译成用户能看懂的语言
4. 给ACL设置ACL: 访问阻断页面会展示用户和设备认证情况，恰好是攻击者想要的，需要平衡用户体验和安全。最极端的情况下就让用户联系技术支持，在确认用户身份后帮助解决问题
5. 访问拒绝页面: 用户点击"Fix this"后，后台会调用API给出具体拦截原因，比如不在某个用户组里、可以点击链接申请，或者设备存在安全问题
6. 其他问题调试: 用户可以在出差检查一下名下所有设备以及信任情况
7. 技术支持授权: 一线支持人员可以根据错误页面获取详情

未来思考

1. 自动识别员工不能自行解决的场景，并通知技术支持。同时也要扩大能自动解决的问题范围

# 第六篇 健康的终端

背景

1. 安全能力的效果取决于你信任哪些系统，BeyondCorp帮助Google从“保护服务”转向“保护这些被信任的系统”。
2. 先前的文章主要介绍如何确认设备出处，本文讲解如何信任设备。主要考虑是用户是第一攻击对象，攻击者会采用复杂的社会工程手段进行投毒，然后利用操作系统巨大的攻击面进行攻击，复用设备信任关系、设备上的凭据以及用户信任关系来渗透其他系统。
3. 用户设备是新的边界，即在一个混合了可信任(企业自研软件+企业身份)和不可信任的软件(外部软件+外部身份)的环境里，平台必须要做分层安全控制，才能防止设备被控制。

威胁定义

1. 未知设备: 未知或者未受管控的设备访问了敏感系统
2. 设备沦陷: 系统或者软件的漏洞被利用
3. 绕过安全控制: 利用错误或者未使用的安全策略控制了目标系统
4. 权限提升: 通过代码执行漏洞获得系统权限并实现持久化控制
5. 软件沦陷: 安装恶意软件并持久化
6. 持续攻击: 由于没有关注，攻击者在不断发起攻击
7. 认证绕过: 凭证窃取或者认证绕过
8. 数据泄露: 未授权访问内存、硬盘或者传输数据
9. 隐藏攻击: 由于缺乏监控和日志，让攻击者持久化控制系统
10. 否认攻击: 攻击者通过清理痕迹阻碍调查

健康的终端定义

1. 能够应对大部分攻击
2. 如果还是沦陷了，能够提供足够的遥测数据来控制影响

应对上述威胁的方法

1. 未知设备: 资产管理、连接敏感系统的设备上限、减少硬件配置种类
2. 设备沦陷: 集中软件管理、安全补丁覆盖、软件自动更新
3. 绕过安全控制: 强制安全策略，比如限制登录用户、移除root权限
4. 权限提升: 分层防御实现快速恢复、确保在日志被屏蔽前能够发出异常报警
5. 软件沦陷: 反病毒；限制未授权的代码执行，最好是白名单，黑名单是个无底洞
6. 持续攻击: 从硬件启动到OS运行，必须是可以远程进行安全校验；如secure boot、remote attestation等等
7. 认证绕过: 凭据应该尽量是基于硬件或者跟当前系统隔离的，比如Windows Defender Guard
8. 数据泄露: 总是假设设备上有凭据，敏感数据应该在存储和传输时加密，丢失后可以远程擦除，并销毁长期凭据
9. 隐藏攻击: 敏感数据访问和修改，包括安全配置和行为等等，都需要包含用户和设备信息，日志应该流式传输到中央系统，避免日志被篡改
10. 否认攻击: 远程应急响应，尽量不要本地操作，不然无法处理大规模事件。

维持健康的终端

1. 构建信任: 通过管理工具安装要求的补丁和软件，将设备转换为可信任的状态
2. 保持信任:
   - 在接收和系统镜像阶段，将设备加入资产库
   - 设备丢失后要求用户主动上报，否则无法获取新的设备
   - 使用类似osquery的工具监控终端状态，包括补丁版本、磁盘加密配置等等
   - BeyondCorp有强安全卡位，比如会引导用户重启安装补丁
3. 检测不健康的机器:
   - 信任推理系统持续观测健康状态，对于异常机器会降级到Identified状态，并通知用户进行修改
   - 应急响应团队会手动移除异常设备的信任关系
4. 灵活的策略
   - 给用户宽限时间，避免用户跟安全做对抗。比如非重要补丁可以推迟一小段时间，设备信任不会立即被降级
   - 在授予和回收权限时，同时上报安全策略信息，可以帮助溯源调查

大规模应用策略

1. 传统方案是先推策略再等用户反馈，我们的方法是先上观察模式。比如针对硬件工程师下推USB策略，可以快速发现边界case，并提前在办公区安排技术支持。
2. 将安全控制手段对应到特定威胁，通过沟通让员工理解安全策略。通过保持透明，来创建共识、让受益人认可，同时还能让设备更加安全。

设备监测

1. 无论是设备还是管理策略上，都很难落地同样的通用策略。比如Chrome OS Secure Access可以实现软件控制，但是Linux系统自己就没有自带的反病毒能力。
2. 因此需要标准化评估流程，具体评估点是，
   - 平台是否支持管控？
   - 管控是否默认开启？
   - 是否能监控管控状态？
   - 设备当前是否合规？
3. 观测手段落地方法
   - 使用公共观测方法: 补丁发布时间、地理位置、数量
   - 使用相对评估方法: 距离最新版差多少个版本，支持的特性 vs 实现的特性
4. 控制能力不足时，需要通过监控能力补齐，可能会变得非常主观。最好的办法还是对比设备状态与理想状态的差距，以此来确定优先级。另外评估过程要详细记录，以方便安全工程师理解设备状态。

偏离理想情况

1. 偏离理想情况很常见，比如操作系统的补丁都是出来一段时间才安装。要避免的是全网出现异常，是否做策略的“硬修正”等等。要了解威胁模型和用户体验的平衡，才能做出好的决策。
2. 异常应该是可测量的，并且能持续的定位根因，找到无法落地的设备或者用户。如果持续产生新的异常，则应该考虑重新设计控制方案，或者重新思考控制目标。

开始落地

1. 定义你关注的安全控制方案: 每个策略都要对应到一个具体的威胁，以此排出优先级；然后通过红队测试验证有效性。
2. 找到可以观测控制效果的点: 通过软件上报设备状态；设备数量规模较大时策略会呈现多样性，需要多个理想状态才能覆盖全集。
3. 找到设备不符合控制目标的点: 先要确保新设备都是合规的，才有精力处理存量设备。
4. 修复与控制目标不符合的工作流程，或者增加例外配置: 对异常进行分类、暴露问题。然后按照影响设备的数量，从大到小开始处理，以获取最大安全收益。重复这个流程直到问题全部解决。

经验教训

1. 早点制定里程碑: 确定重点关注的设备、调整资源分配；将资产库跟授权系统关联，避免未知设备访问重要服务；这样的好处是，可以知道哪些设备是健康设备。
2. 确定例外处理流程: 尽早确定技术和流程方案，以及哪些场景可以做例外策略、如何记录例外、最长允许例外的时间、评估流程等等
3. 尽早跟合作方、受影响的团队沟通: BeyondCorp落地需要整个IT部门协同；尽量让大多数用户可以自己解决问题，而不是上升到IT团队。

# 第七篇 长尾零信任

摘要

- 随着大部分工作流完成迁移，BeyondCorp后期投入产出比越来越低，剩下的都是难以解决的长尾场景(管理层支持、工具和数据的不足)
- 本文重点讲解如何通过流程和工具应对这些场景

难以迁移的场景

1. 无法给网关提交证书
2. 直连IP地址，非HTTPS协议
3. 有IP白名单
4. 有带宽和延迟要求(比如地理位置)

例外管理

1. 针对已知不兼容场景，员工自助加白
2. 其他场景，打印机、SSH、IRC(IM)
3. 这些例外方案都持续存在了很久，后来随着支持力度减弱，数据分析流程也关闭了。然而随着员工数量不断增长，不同的问题可能涉及少数用户，也可能是上千个用户。这些人的需求对项目组变得模糊。因此，
   1. 例外方案应该有过期时间
   2. 例外方案需要有专人支持，防止用户申请不必要的例外
   3. 需要在安全、技术支持、变更管理、SRE、项目管理多个维度投入资源，而不是等着业务侧主动更新

临时解决方案

1. 非浏览器访问的单独搭建代理，填充用户或者机器凭据，来实现跟AP的兼容。代理运行在客户端所在的机器，本地监听端口
2. 用微隔离VPN作为兜底措施，支持那种无法运行任意程序的客户端，比如嵌入式系统
   1. VPN客户端通过websocket连接到AP，AP转发到VPN HTTP服务器
   2. VPN客户端通过NAT访问内网有限的地址
   3. VPN后端跟应用服务建立连接
3. 折中方案
   1. VPN下面没有特权网络，疫情期间很多员工无法办公，通过支持团队按人配置策略解决
   2. VPN可以做微隔离
   3. 早日移除网络层的信任，可以避免后面其他工作流再有依赖
4. 解决部分例外场景
   1. 打印机: 走第三方HTTPS云服务
   2. SSH: AP SSH代理
   3. IRC: 移动到生产环境，只允许信任的机器访问，做好灾备控制

迁移策略

1. 方案需要考虑，用户影响范围和业务连续性、技术支持力度、用户测试是否全面
2. 在沟通的时候，同一个用户可能会有其他不兼容的工作流，因此，
   1. 提前通知，确定用户迁移日期
   2. 文档和FAQ
   3. 分几天逐步迁移
   4. 自助退出机制，但是要给出迁移回来的日期。如果可以的话，给出无法迁移的工作流负责人

迁移程序

1. 当用户需要配置例外策略，找到工作流的支持团队
2. 与支持团队一起理解用户工作流和需求，提出并验证解决方案
3. 使用标准流程进行迁移
4. 如果用户选择退出这个流程，研判是否有新的工作流并重复这个流程

其他说明:

1. 并不是所有的工作流都会被项目组关注
2. 明确迁移时间点，以及问题上升机制
3. 获取高层的关注，包括月度进展、后续迁移计划发布等等

# 开源项目

- https://github.com/google/capirca